@page "/"

<style>


    table {
        text-align: center
    }

    thead {
        font-weight: bold;
        font-size: 16px;
    }

    .btn-success.active {
        border: 4px solid;
        background-color: #00710e;
    }

    .btn-danger.active {
        border: 4px solid;
        background-color: #7c0000;
    }
</style>

<div class="container">

    <h1 class="text-center">Welcome to Race to 21!</h1>

    @switch (Game.nextTask)
    {
        case Tasks.GetNumberOfPlayers:

            <hr />

            <p class="text-center">This game requires 2-6 players to participate.</p>

            <hr />


            <h3 class="text-center">How many players?</h3>
            <div class="row justify-content-center">
                <input type="number" class="col-2" min="2" max="6" @bind="Game.numberOfPlayers" />
            </div>

            <div class="row justify-content-center">
                <button type="button" class="btn btn-primary mt-3" @onclick="() => { Game.nextTask = Tasks.GetNames;}">
                    Next
                </button>
            </div>
            break;

        case Tasks.GetNames:

            <hr />

            <p class="text-center">Each player's name should be different.</p>

            <hr />


            @for (int i = 0; i < Game.numberOfPlayers; i++)
            {
                int playerNumnber = i;
                <div class=" row justify-content-center">
                    <h3>Player#@(i + 1): </h3>
                    <input type="text" placeholder="Enter your name" @bind-value="playerNames[playerNumnber]" />

                </div>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-3" role="alert">
                    @errorMessage
                </div>
            }


            <div class="row justify-content-center">
                <button type="button" class="btn btn-primary mt-3" @onclick="() => { AddPlayers(); }">
                    Add Players
                </button>

                <button type="button" class="btn btn-primary mt-3" @onclick="() => { Game.nextTask = Tasks.GetNumberOfPlayers; }">
                    Change Player Number
                </button>
            </div>

            break;
        case Tasks.PlayerTurn:

            <hr />
            <p class="text-center">When a player draws a card, he or she can choose to draw 0-3 cards.</p>
            <p class="text-center">If the player chooses to draw 0 cards, the player's status changes to "Stay" and no more cards can be drawn.</p>
            <p class="text-center">If the total number of points in a player's hand exceeds 21, the player's status changes to "Bust" and he/she cannot draw any more cards.</p>
            <p class="text-center">When the total number of points in a player's hand is 21, the player wins and the turn ends.</p>

            <hr />

            <p></p>

            <hr />


            @if (Game.players.Count < 4)
            {
                <table class="table table-bordered justify-content-center">
                    <thead>
                        <tr class="col-3">
                            @foreach (Player player in Game.players)
                            {
                                <td>@player.name</td>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="col-3">
                            @foreach (Player player in Game.players)
                            {
                                <td>@player.status</td>
                            }
                        </tr>
                        <tr class="col-3">
                            @foreach (Player player in Game.players)
                            {
                                <td>
                                    <div class="text-center">
                                        Hands:
                                    </div>


                                    @foreach (Card card in player.cards)
                                    {

                                        <img src="card_assets/@card.FullName" />

                                    }
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @foreach (Player player in Game.players)
                            {
                                <td>
                                    Score: @player.score
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @foreach (Player player in Game.players)
                            {
                                <td>
                                    Points:  @player.points
                                </td>
                            }
                        </tr>

                    </tbody>
                </table>
            }
            else
            {
                <table class="table table-bordered justify-content-center">
                    <thead>
                        <tr class="col-3">
                            @for (int i = 0; i < 3; i++)
                            {
                                <td>@Game.players[i].name</td>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="col-3">
                            @for (int i = 0; i < 3; i++)
                            {
                                <td>@Game.players[i].status</td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 0; i < 3; i++)
                            {
                                <td>
                                    <div class="text-center">
                                        Hands:
                                    </div>


                                    @foreach (Card card in Game.players[i].cards)
                                    {

                                        <img src="card_assets/@card.FullName" />

                                    }
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 0; i < 3; i++)
                            {
                                <td>
                                    Score: @Game.players[i].score
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 0; i < 3; i++)
                            {
                                <td>
                                    Points:  @Game.players[i].points
                                </td>
                            }
                        </tr>

                    </tbody>

                </table>

                <table class="table table-bordered justify-content-center">
                    <thead>
                        <tr class="col-3">
                            @for (int i = 3; i < Game.players.Count; i++)
                            {
                                <td>@Game.players[i].name</td>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="col-3">
                            @for (int i = 3; i < Game.players.Count; i++)
                            {
                                <td>@Game.players[i].status</td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 3; i < Game.players.Count; i++)
                            {
                                <td>
                                    <div class="text-center">
                                        Hands:
                                    </div>


                                    @foreach (Card card in Game.players[i].cards)
                                    {

                                        <img src="card_assets/@card.FullName" />

                                    }
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 3; i < Game.players.Count; i++)
                            {
                                <td>
                                    Score: @Game.players[i].score
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 3; i < Game.players.Count; i++)
                            {
                                <td>
                                    Points:  @Game.players[i].points
                                </td>
                            }
                        </tr>

                    </tbody>

                </table>

            }

            <hr />

            <div class="row justify-content-center">
                <input type="range" min="0" max="3" @bind="drawCardsNumber" />
                <div class="col-2">@drawCardsNumber</div>
            </div>



            @if (Game.players[Game.currentPlayer].status == PlayerStatus.active)
            {
                <div class="text-center">
                    <h3>Player <b>"@Game.players[Game.currentPlayer].Name"</b> draw cards!</h3>
                </div>
            }
            else
            {
                <div class="text-center">
                    <h3><b>"@Game.players[Game.currentPlayer].Name"</b>, you can not draw cards, click the button to go to the next player!</h3>
                </div>
            }



            <div class="row justify-content-center">
                <button type="button" class="btn btn-primary mt-3" @onclick="() => { PlayerDrawCards(drawCardsNumber); CheckWinner();  }">
                    Draw Cards
                </button>
            </div>


            break;

        case Tasks.CheckForEnd:

            <hr />
            <p class="text-center">The game will end when either of the two cases occurs during the game.</p>
            <p class="text-center">Case 1: One player has more than 60 points.</p>
            <p class="text-center">Case 2: The number of players on the field is less than or equal to one.</p>
            <hr />

            @if (Game.players.Count < 4)
            {
                <table class="table table-bordered justify-content-center">
                    <thead>
                        <tr class="col-3">
                            @foreach (Player player in Game.players)
                            {
                                <td>@player.name</td>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="col-3">
                            @foreach (Player player in Game.players)
                            {
                                <td>@player.status</td>


                            }
                        </tr>
                        <tr class="col-3">
                            @foreach (Player player in Game.players)
                            {
                                <td>
                                    <div class="text-center">
                                        Hands:
                                    </div>


                                    @foreach (Card card in player.cards)
                                    {

                                        <img src="card_assets/@card.FullName" />

                                    }
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @foreach (Player player in Game.players)
                            {
                                <td>
                                    Score: @player.score
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @foreach (Player player in Game.players)
                            {
                                <td>
                                    Points:  @player.points
                                </td>
                            }
                        </tr>

                    </tbody>
                </table>
            }
            else
            {
                <table class="table table-bordered justify-content-center">
                    <thead>
                        <tr class="col-3">
                            @for (int i = 0; i < 3; i++)
                            {
                                <td>@Game.players[i].name</td>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="col-3">
                            @for (int i = 0; i < 3; i++)
                            {
                                <td>@Game.players[i].status</td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 0; i < 3; i++)
                            {
                                <td>
                                    <div class="text-center">
                                        Hands:
                                    </div>


                                    @foreach (Card card in Game.players[i].cards)
                                    {

                                        <img src="card_assets/@card.FullName" />

                                    }
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 0; i < 3; i++)
                            {
                                <td>
                                    Score: @Game.players[i].score
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 0; i < 3; i++)
                            {
                                <td>
                                    Points:  @Game.players[i].points
                                </td>
                            }
                        </tr>

                    </tbody>

                </table>

                <table class="table table-bordered justify-content-center">
                    <thead>
                        <tr class="col-3">
                            @for (int i = 3; i < Game.players.Count; i++)
                            {
                                <td>@Game.players[i].name</td>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="col-3">
                            @for (int i = 3; i < Game.players.Count; i++)
                            {
                                <td>@Game.players[i].status</td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 3; i < Game.players.Count; i++)
                            {
                                <td>
                                    <div class="text-center">
                                        Hands:
                                    </div>


                                    @foreach (Card card in Game.players[i].cards)
                                    {

                                        <img src="card_assets/@card.FullName" />

                                    }
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 3; i < Game.players.Count; i++)
                            {
                                <td>
                                    Score: @Game.players[i].score
                                </td>


                            }
                        </tr>
                        <tr class="col-3">
                            @for (int i = 3; i < Game.players.Count; i++)
                            {
                                <td>
                                    Points:  @Game.players[i].points
                                </td>
                            }
                        </tr>

                    </tbody>

                </table>

            }

            <hr />

            <h2 class="text-center">
                Do you want to play another round?
            </h2>



            for (int i = 0; i < Game.players.Count; i++)
            {
                int playerIndex = i;
                <label for="@playerIndex" class="col-sm-6 col-form-label text-sm-right">
                    @Game.players[playerIndex].Name
                </label>

                <button type="button" class="btn btn-success @((Game.players[playerIndex].isContinue == true) ? "active" : "")" @onclick="() => { Game.players[playerIndex].isContinue = true; }">Yes</button>
                <button type="button" class="btn btn-danger @((Game.players[playerIndex].isContinue == false) ? "active" : "")" @onclick="() => { Game.players[playerIndex].isContinue = false; }">No</button>

            }

            <div class="row justify-content-center">
                <button type="button" class="btn btn-primary mt-3" @onclick="ReBuildPlayerList">
                    Next
                </button>
            </div>
            break;

        case Tasks.GameOver:
            <div class="justify-content-center">
                @foreach (Player player in Game.players)
                {
                    <div class="text-center">
                        @player.name has @player.points points.
                    </div>
                }

                @foreach (Player player in Game.giveUpPlayers)
                {
                    <div class="text-center">
                        @player.name has @player.points points.
                    </div>
                }

                <hr />

                @if (Game.players.Find(player => player.points == Game.highPoints) != null)
                {
                    <div class="text-center">
                        <h3>
                            @Game.players.Find(player => player.points == Game.highPoints).Name  is the final winner!
                        </h3>
                    </div>
                }
                else if (Game.giveUpPlayers.Find(player => player.points == Game.highPoints) != null)
                {
                    <div class="text-center">
                        <h3>
                            @Game.giveUpPlayers.Find(player => player.points == Game.highPoints).Name  is the final winner!
                        </h3>
                    </div>
                }

                <div class="row justify-content-center">
                    <button class="btn btn-primary mt-3" @onclick="ResetGame">
                        Reset
                    </button>
                </div>

            </div>

            break;


    }

</div>

@code{

    protected override void OnInitialized()
    {

        Game.SetUpGame();

    }

    string[] playerNames = new string[6];

    string errorMessage = "";

    int drawCardsNumber;

    int lastTotalPlayers;

    /// <summary>
    /// Check for duplicate names 
    /// </summary>
    /// <returns>If not, return true. Otherwise, false.</returns>
    private bool IsNameValid()
    {
        if (playerNames.Take(Game.numberOfPlayers).GroupBy(name => name).Any(group => group.Count() > 1))
        {
            errorMessage = "Please make sure all player names are unique.";
            return false;
        }

        return true;
    }

    /// <summary>
    /// Add players to player list
    /// </summary>
    private void AddPlayers()
    {
        if (IsNameValid())
        {
            for (int i = 0; i < Game.numberOfPlayers; i++)
            {
                Game.AddPlayer(playerNames[i]);
            }
            Game.nextTask = Tasks.PlayerTurn;
        }

    }

    /// <summary>
    /// Dealing to players when the player's status is "active"
    /// </summary>
    /// <param name="drawCardsNumber">How many cards the play want to draw</param>
    private void PlayerDrawCards(int drawCardsNumber)
    {
        Player player = Game.players[Game.currentPlayer];
        if (player.status == PlayerStatus.active)
        {
            /* Implementation:
             * A player can choose to draw up to 3 cards each turn, but they get
             * all cards at once; they don’t get to decide after each card
             */
            if (drawCardsNumber != 0) // If the player want to draw cards
            {

                for (int i = 0; i < drawCardsNumber; i++) // Draw the number of cards indicated by the player
                {
                    Card card = Game.deck.DealTopCard();
                    player.cards.Add(card);
                }

                player.score = Game.ScoreHand(player);


                if (player.score > 21) // The player bust
                {
                    player.status = PlayerStatus.bust;

                    int losePoints = player.score - 21; // Implementation: If the player is bust, the player loses points equal to their hand total minus 21. (Level 2)
                    player.points -= losePoints;

                }
                else if (player.score == 21) // The player win
                {
                    player.status = PlayerStatus.win;
                }
            }
            else // The player do not want to draw cards at the beginning of the round.
            {
                player.status = PlayerStatus.stay;
            }

        }

    }


    /// <summary>
    /// Check all win condition, and figure out if there is a winner.
    /// If there is a winner, go to the next page.
    /// </summary>
    private void CheckWinner()
    {
        if (!Game.CheckActivePlayers()) // No players' status is active
        {
            Player winner = Game.DoFinalScoring(); // Get the winner

            if (winner != null) // Implementation: When a player win, the player earns the points equal to his score. (Level 1)
            {
                winner.status = PlayerStatus.win;
                winner.points += winner.score;
            }


            // Adjust: Put the winner detection out of the AnnounceWinner method. If no player draws card, the game will not stop.
            if (winner != null) // If there is a winner
            {
                Game.currentPlayer = 0;
                int highPoints = 0;

                lastTotalPlayers = Game.players.Count;
                for (int i = 0; i < Game.players.Count; i++)
                {
                    if (Game.players[i].points > highPoints)
                    {
                        highPoints = Game.players[i].points;
                    }
                }
                Game.highPoints = highPoints;

                if (Game.highPoints < Game.pointsToGameOver)
                {
                    Game.nextTask = Tasks.CheckForEnd;
                }
                else
                {
                    Game.nextTask = Tasks.GameOver;
                }


            }
            else // There is no winner
            {
                foreach (var player in Game.players) // Reset all players status
                {
                    player.status = PlayerStatus.active;
                }

                if (Game.currentPlayer >= (Game.players.Count - 1)) // If the current player is the final player, reset the variable currentPlayer
                {
                    Game.currentPlayer = 0; // back to the first player...
                }

                Game.nextTask = Tasks.PlayerTurn;
            }

        }
        else // someone's status is active
        {
            if (Game.currentPlayer == (Game.players.Count - 1)) // Last player acts
            {
                Game.currentPlayer = 0;
            }
            else // Other player acts
            {
                Game.currentPlayer++;
            }

            Game.nextTask = Tasks.PlayerTurn;
        }
    }


    /// <summary>
    /// Check all players, if a player decide to continue play th game, then reset the player hands, score and make the players status be "active". 
    /// If a player don't want to continue, then remove that player to another list.
    /// If the number of player minus and more than 1, then shuffle the player list, rebuild the deck and shuffle the deck.
    /// If the number of player equal or less than 1, then Game Over.
    /// </summary>
    private void ReBuildPlayerList()
    {
        for (int i = 0; i < Game.players.Count; i++)
        {
            if (Game.players[i].isContinue == true)
            {
                Game.players[i].cards = new List<Card>();
                Game.players[i].score = 0;
                Game.players[i].status = PlayerStatus.active;
            }
            // If the player disagree, the player will be removed
            else if (Game.players[i].isContinue == false)
            {
                Game.giveUpPlayers.Add(Game.players[i]);
                Game.players.RemoveAt(i);
                i--; // When data in the list is removed, the Index of all the data after it is subtracted by one, so here i is also subtracted by one to avoid skipping data.

            }
        }

        if (Game.players.Count <= lastTotalPlayers && Game.players.Count > 1) // The number of player minus and there are still two or more players
        {
            Game.shufflePlayer();
            Game.deck.buildDeck();
            Game.deck.Shuffle();

            /*nextTask = Tasks.IntroducePlayers;*/
            Game.nextTask = Tasks.PlayerTurn;
        }
        else
        {
            Game.nextTask = Tasks.GameOver;
        }

    }


    /// <summary>
    /// Clear all information about the game and go back to the start page
    /// </summary>
    private void ResetGame()
    {
        Game.players = new List<Player>();
        Game.giveUpPlayers = new List<Player>();
        Game.numberOfPlayers = 2;
        Game.deck.buildDeck();
        Game.deck.Shuffle();

        drawCardsNumber = 0;
        playerNames = new string[8];

        Game.nextTask = Tasks.GetNumberOfPlayers;
    }

}

