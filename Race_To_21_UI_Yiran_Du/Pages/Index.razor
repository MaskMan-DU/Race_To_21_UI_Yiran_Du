@page "/"

<style>
    tr {
        text-align: center;
    }
</style>

<div class="container">

    <h1 class="text-center">Welcome to Race to 21!</h1>

    @switch (Game.nextTask)
    {
        case Tasks.GetNumberOfPlayers:
            <h2 class="text-center">How many players?</h2>
            <div class="row justify-content-center">
                <input type="number" class="col-2" min="2" max="8" @bind="Game.numberOfPlayers" />
            </div>

            <div class="row justify-content-center">
                <button type="button" class="btn btn-primary mt-3" @onclick="() => { Game.nextTask = Tasks.GetNames;}">
                    Next
                </button>
            </div>
            break;

        case Tasks.GetNames:
            @for (int i = 0; i < Game.numberOfPlayers; i++)
            {
                int playerNumnber = i;
                <div class=" row justify-content-center">
                    <h3>Player#@(i + 1): </h3>
                    <input type="text" @bind-value="playerNames[playerNumnber]" />

                </div>
            }

            <div class="row justify-content-center">
                <button type="button" class="btn btn-primary mt-3" @onclick="() => { AddPlayers(); Game.nextTask = Tasks.PlayerTurn; }">
                    Add Players
                </button>

                <button type="button" class="btn btn-primary mt-3" @onclick="() => { Game.nextTask = Tasks.GetNumberOfPlayers; }">
                    Change Player Number
                </button>
            </div>

            break;
        case Tasks.PlayerTurn:
            <h2 class="text-center">The final winner will be the one who has more than 60 points!</h2>
            <h2 class="text-center">If everyone quits early, or if only one player is present, the player who has the highest points wins！</h2>



            @if (Game.players.Count < 5)
            {
                <table class="table table-bordered justify-content-center">
                    @foreach (Player player in Game.players)
                    {
                        <td class="col-3" style="text-align:center">
                        <tr class="border">@player.Name</tr>
                        <tr class="border">@player.status</tr>
                        <tr class="border">

                            <div class="text-center">
                                Hands:
                            </div>


                            @foreach (Card card in player.cards)
                            {

                                <img src="card_assets/@card.FullName" />

                            }


                        </tr>
                        <tr class="border">Score: @player.score</tr>
                        <tr class="border">Points: @player.points</tr>
                        </td>
                    }
                </table>
            }
            else
            {
                <table class="table table-bordered justify-content-center">
                    @for (int i = 0; i < 4; i++)
                    {
                        <td class="col-3" style="text-align:center">
                        <tr class="border">@Game.players[i].Name</tr>
                        <tr class="border">@Game.players[i].status</tr>
                        <tr class="border">

                            <div class="text-center">
                                Hands:
                            </div>


                            @foreach (Card card in Game.players[i].cards)
                            {

                                <img src="card_assets/@card.FullName" />

                            }


                        </tr>
                        <tr class="border">Score: @Game.players[i].score</tr>
                        <tr class="border">Points: @Game.players[i].points</tr>
                        </td>
                    }
                </table>

                <table class="table table-bordered justify-content-center">
                    @for (int i = 4; i < Game.players.Count; i++)
                    {
                        <td class="col-3" style="text-align:center">
                        <tr class="border">@Game.players[i].Name</tr>
                        <tr class="border">@Game.players[i].status</tr>
                        <tr class="border">

                            <div class="text-center">
                                Hands:
                            </div>


                            @foreach (Card card in Game.players[i].cards)
                            {

                                <img src="card_assets/@card.FullName" />

                            }


                        </tr>
                        <tr class="border">Score: @Game.players[i].score</tr>
                        <tr class="border">Points: @Game.players[i].points</tr>
                        </td>
                    }
                </table>

            }



            <input class="justify-content-center" type="range" min="0" max="3" @bind="drawCardsNumber" />
            <div class="col-2">@drawCardsNumber</div>

            <div class="text-center">
                Player "@Game.players[Game.currentPlayer].Name" draw cards!
            </div>

            <button type="button" class="btn btn-primary mt-3" @onclick="() => { PlayerDrawCards(drawCardsNumber); CheckWinner(); }">
                Draw Cards
            </button>

            break;

        case Tasks.CheckForEnd:

            @if (Game.highPoints < Game.pointsToGameOver)
            {
                @if (Game.players.Count < 5)
                {
                    <table class="table table-bordered justify-content-center">
                        @foreach (Player player in Game.players)
                        {
                            <td class="col-3 justify-content-center">
                            <tr class="border">@player.Name</tr>
                            <tr class="border">@player.status</tr>
                            <tr class="border">

                                <div class="text-center">
                                    Hands:
                                </div>


                                @foreach (Card card in player.cards)
                                {

                                    <img src="card_assets/@card.FullName" />

                                }


                            </tr>
                            <tr class="border">Score: @player.score</tr>
                            <tr class="border">Points: @player.points</tr>
                            </td>
                        }
                    </table>
                }
                else
                {
                    <table class="table table-bordered justify-content-center">
                        @for (int i = 0; i < 4; i++)
                        {
                            <td class="col-3 justify-content-center">
                            <tr class="border">@Game.players[i].Name</tr>
                            <tr class="border">@Game.players[i].status</tr>
                            <tr class="border">

                                <div class="text-center">
                                    Hands:
                                </div>


                                @foreach (Card card in Game.players[i].cards)
                                {

                                    <img src="card_assets/@card.FullName" />

                                }


                            </tr>
                            <tr class="border">Score: @Game.players[i].score</tr>
                            <tr class="border">Points: @Game.players[i].points</tr>
                            </td>
                        }
                    </table>

                    <table class="table table-bordered justify-content-center">
                        @for (int i = 4; i < Game.players.Count; i++)
                        {
                            <td class="col-3 justify-content-center">
                            <tr class="border">@Game.players[i].Name</tr>
                            <tr class="border">@Game.players[i].status</tr>
                            <tr class="border">

                                <div class="text-center">
                                    Hands:
                                </div>


                                @foreach (Card card in Game.players[i].cards)
                                {

                                    <img src="card_assets/@card.FullName" />

                                }


                            </tr>
                            <tr class="border">Score: @Game.players[i].score</tr>
                            <tr class="border">Points: @Game.players[i].points</tr>
                            </td>
                        }
                    </table>

                }

                <br />

                <h2 class="text-center">
                    Do you want to play another round?
                </h2>



                for (int i = 0; i < Game.players.Count; i++)
                {
                    int playerIndex = i;
                    <label for="@playerIndex" class="col-sm-6 col-form-label text-sm-right">
                        @Game.players[playerIndex].Name
                    </label>

                    <input type="checkbox" @bind="Game.players[playerIndex].isContinue" />

                }

                <div class="justify-content-center">
                    <button type="button" class="btn btn-primary mt-3" @onclick="ReBuildPlayerList">
                        Next
                    </button>
                </div>
            }
            else
            {
                Game.nextTask = Tasks.GameOver;
            }
            break;
        case Tasks.GameOver:
            <div class="justify-content-center">
                @foreach (Player player in Game.players)
                {
                    <div>
                        @player.name has @player.points.
                    </div>
                }

                @foreach (Player player in Game.giveUpPlayers)
                {
                    <div>
                        @player.name has @player.points.
                    </div>
                }


                @if (Game.players.Find(player => player.points == Game.highPoints) != null)
                {
                    <div class="text-center">
                        @Game.players.Find(player => player.points == Game.highPoints).Name  is the final winner!
                    </div>
                }
                else if (Game.giveUpPlayers.Find(player => player.points == Game.highPoints) != null)
                {
                    <div class="text-center">
                        @Game.giveUpPlayers.Find(player => player.points == Game.highPoints).Name  is the final winner!
                    </div>
                }

            <div class="justify-content-center">
                <button class="btn btn-primary mt-3" @onclick="() => { Game.nextTask = Tasks.GetNumberOfPlayers; }">
                    Reset
                </button>
            </div>

            </div>

            break;


    }

</div>

@code{

    protected override void OnInitialized()
    {

        Game.SetUpGame();

    }

    string[] playerNames = new string[8];

    bool[] buttonIsDisable = new bool[8];

    int drawCardsNumber;

    int lastTotalPlayers;

    private void AddPlayers()
    {
        for (int i = 0; i < Game.numberOfPlayers; i++)
        {
            Game.AddPlayer(playerNames[i]);
        }
    }

    private void PlayerDrawCards(int drawCardsNumber)
    {
        Player player = Game.players[Game.currentPlayer];
        if (player.status == PlayerStatus.active)
        {
            /* Implementation:
             * A player can choose to draw up to 3 cards each turn, but they get
             * all cards at once; they don’t get to decide after each card
             */
            if (drawCardsNumber != 0) // If the player want to draw cards
            {

                for (int i = 0; i < drawCardsNumber; i++) // Draw the number of cards indicated by the player
                {
                    Card card = Game.deck.DealTopCard();
                    player.cards.Add(card);
                }

                player.score = Game.ScoreHand(player);


                if (player.score > 21) // The player bust
                {
                    player.status = PlayerStatus.bust;

                    int losePoints = player.score - 21; // Implementation: If the player is bust, the player loses points equal to their hand total minus 21. (Level 2)
                    player.points -= losePoints;

                }
                else if (player.score == 21) // The player win
                {
                    player.status = PlayerStatus.win;
                }
            }
            else // The player do not want to draw cards at the beginning of the round.
            {
                player.status = PlayerStatus.stay;
            }

        }

    }


    private void CheckWinner()
    {
        if (!Game.CheckActivePlayers()) // No players' status is active
        {
            Player winner = Game.DoFinalScoring(); // Get the winner

            if (winner != null) // Implementation: When a player win, the player earns the points equal to his score. (Level 1)
            {
                winner.status = PlayerStatus.win;
                winner.points += winner.score;
            }


            // Adjust: Put the winner detection out of the AnnounceWinner method. If no player draws card, the game will not stop.
            if (winner != null) // If there is a winner
            {
                Game.currentPlayer = 0;

                lastTotalPlayers = Game.players.Count;
                for (int i = 0; i < Game.players.Count; i++)
                {
                    if (Game.players[i].points > Game.highPoints)
                    {
                        Game.highPoints = Game.players[i].points;
                    }
                }
                Game.nextTask = Tasks.CheckForEnd;

            }
            else // There is no winner
            {
                foreach (var player in Game.players) // Reset all players status
                {
                    player.status = PlayerStatus.active;
                }

                if (Game.currentPlayer >= (Game.players.Count - 1)) // If the current player is the final player, reset the variable currentPlayer
                {
                    Game.currentPlayer = 0; // back to the first player...
                }

                Game.nextTask = Tasks.PlayerTurn;
            }

        }
        else // someone's status is active
        {
            if (Game.currentPlayer == (Game.players.Count - 1)) // Last player acts
            {
                Game.currentPlayer = 0;
            }
            else // Other player acts
            {
                Game.currentPlayer++;
            }

            Game.nextTask = Tasks.PlayerTurn;
        }
    }

    private void ReBuildPlayerList()
    {
        for (int i = 0; i < Game.players.Count; i++)
        {
            if (Game.players[i].isContinue == true)
            {
                Game.players[i].cards = new List<Card>();
                Game.players[i].score = 0;
                Game.players[i].status = PlayerStatus.active;
            }
            // If the player disagree, the player will be removed
            else if (Game.players[i].isContinue == false)
            {
                Game.giveUpPlayers.Add(Game.players[i]);
                Game.players.RemoveAt(i);
                i--; // When data in the list is removed, the Index of all the data after it is subtracted by one, so here i is also subtracted by one to avoid skipping data.

            }
        }

        if (Game.players.Count <= lastTotalPlayers && Game.players.Count > 1) // The number of player minus and there are still two or more players
        {
            Game.shufflePlayer();
            Game.deck.buildDeck();
            Game.deck.Shuffle();

            /*nextTask = Tasks.IntroducePlayers;*/
            Game.nextTask = Tasks.PlayerTurn;
        }
        else
        {
            Game.nextTask = Tasks.GameOver;
        }

    }

}

